{% extends 'base.html' %}

{% block content %}

<div class="container">

  <h1>crea un corso</h1>
  <p>(Nota) rifai la grafica</p>

  <div class="line"></div>

  <div id="error" class="alert alert-danger"></div>

  <div class="myform">
    <!-- implelement creatore server side
    <div class="creator"><p>Creatore</p></div>-->

    {{ crea_corso_form.as_p }}

    {% for fascia in fasce %}
      <input type="button" value="{{fascia}}" class="fasciabutton btn btn-secondary" onclick="aggiungi_fascia(this)">
    {% endfor %}

    <div class="line"></div>

    <div class="aggiungiospitantiform">
      <p>Nota: inserisci nome, cognome e classe (es: Mario Rossi 1a) degli studenti che terranno il corso</p>
      <div class="ospitanti"></div>

      nome e cognome: <input type="text" id="ospitanti" placeholder="aggiungi studente ospitante...">
      classe: <input type="text" id="classedellospitante" placeholder="">
      <button id="aggiungiospitante" onclick="aggiungi_studente()">Aggiungi</button>
    </div>

    <div class="line"></div>

    <p>Nota: premendo questo bottone verrà creato il corso</p>
    <button onclick="crea_corso(this)" class="btn btn-primary">Crea</button>
  </div>

</div>

<script>
var aula = ""
var fascia = []
var studenti_referenti = []
var classi = []

//page rendering
$(document).ready(function () {
  $('#creacorso').toggleClass('active')
  $('#homelink').toggleClass('active')
  $('#id_aula').on('change',function(){
    aula= $("#id_aula option:selected").text();
  });
})
//messaggi a chiunque abbia strane idee sulla sicurezza del mio codice
console.log('Whooo, hai scoperto la console del sito! Chi sei, un hacker?')
console.log('Nel caso ti stessero venendo strane idee, sappi che il server esegue verifiche server-side contro SQL-injection, brute force e simili.')
console.log('P.S: if (sei un programmatore && vorresti aiutare a sviluppare la settimana flessibile) {iscriviti al corso: "come è stato fatto questo sito}".')

//fasce
function toogle_fascia(str) {
  if (fascia.includes(str)) {
    var index = fascia.indexOf(str);
    if (index > -1) {fascia.splice(index, 1);}
  } else {fascia.push(str)}
}
function aggiungi_fascia(nome_fascia) {
  var x = nome_fascia;
  x.classList.toggle('btn-info');
  x.classList.toggle('btn-secondary');
  var new_button = x.parentNode.replaceChild(x, nome_fascia);
  toogle_fascia(x.value)
}

function getCookie(name) {var cookieValue = null;if (document.cookie && document.cookie != '') {var cookies = document.cookie.split(';');
       for (var i = 0; i < cookies.length; i++) {var cookie = jQuery.trim(cookies[i]);if (cookie.substring(0, name.length + 1) == (name + '=')) {
         cookieValue =   decodeURIComponent(cookie.substring(name.length + 1));break;}}}return cookieValue;}
 var csrftoken = getCookie('csrftoken');function csrfSafeMethod(method) {return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));}

//studenti referenti
function validate_studente(n, c) {
  //temporary, waiting implementation
  return true
}
function aggiungi_studente() {
  nome_cognome = $('#ospitanti').val();
  classe = $('#classedellospitante').val();
  if (validate_studente(nome_cognome, classe) == true) {
    var button = '<button class="btn btn-primary"onclick="rimuovi_studente(this)">Rimuovi</button>';
    var text = `<div class="studenti"><span>${nome_cognome}</span>, <span>${classe}</span>. ${button}</div<br>`;
    $('.ospitanti').append(text);
    studenti_referenti.push(nome_cognome);
    classi.push(classe)
  }
  console.log(classi)
}
function rimuovi_studente(studente) {
  studenti_referenti.splice(studenti_referenti.indexOf(studente.parentNode.firstChild.innerHTML), 1);
  studente.parentNode.parentNode.removeChild(studente.parentNode);
  classi.splice(classi.indexOf(studente.parentNode.children[1].innerHTML), 1);
  console.log(classi)
}

function validate_data() {
  //temporary, waiting implementation
  return true
}

function crea_corso(crea_btn) {
  crea_btn.innerHTML = 'Creando il corso...';

  var titolo = $('#id_nome').val();
  var descrizione = $('#id_descrizione').val();
  var progressivo = $('#id_is_progressive').is(':checked');
  var a = aula
  var fasce = fascia;
  var ospiti = studenti_referenti;

  console.log(classi)

  if (validate_data() == false) {
    crea_btn.innerHTML = 'crea';
    return;
  }

  var csrftoken = getCookie('csrftoken');
  $.ajax({
    beforeSend: function(xhr, settings) {
      if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
        xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
    },
    url: '/creacorso/',
    data: {
      'titolo': titolo,
      'descrizione': descrizione,
      'is_progressive': progressivo,
      'fasce[]': fasce,
      'ospiti[]': ospiti,
      'aula': a,
      'classi[]': classi,
    },
    method: 'POST',
    datatype: 'json',
    success: function(r_d) {
      if (r_d['success']) {
        window.location.replace("/");crea_btn.innerHTML = 'crea';}
      else {
        $('#error').html(r_d['error'])
      }
    }
});

}
</script>

{% endblock %}
